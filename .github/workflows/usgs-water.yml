name: USGS Water Cache (daily)

on:
  workflow_dispatch:
  schedule:
    - cron: "16 12 * * *" # daily @ 12:16 UTC (adjust as you like)

permissions:
  contents: write

jobs:
  cache-water:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Fetch USGS temp (00010) + cond (00095) for all states & territories
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data

          node - <<'NODE'
          const fetch = global.fetch;
          const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

          // States + DC + PR (lowercase for requests)
          const states = [
            "al","ak","az","ar","ca","co","ct","de","dc","fl","ga","hi",
            "ia","id","il","in","ks","ky","la","ma","md","me","mi","mn",
            "mo","ms","mt","nc","nd","ne","nh","nj","nm","nv","ny","oh",
            "ok","or","pa","pr","ri","sc","sd","tn","tx","ut","va","vt",
            "wa","wi","wv","wy"
          ];

          const params = "parameterCd=00010,00095&siteType=ST&siteStatus=active&format=json";
          const BAD = -1000; // treat <= -1000 as missing (handles -999999 sentinels)

          const bySite = new Map();

          const norm = (v) => {
            const n = Number(v);
            return Number.isFinite(n) && n > BAD ? n : null;
          };

          function stateOf(tsObj) {
            const props = tsObj?.sourceInfo?.siteProperty || [];
            const st = props.find(p => p?.name === "stateCd")?.value;
            return (st || "").toLowerCase();
          }
          function siteCode(tsObj) {
            return tsObj?.sourceInfo?.siteCode?.[0]?.value || "";
          }
          function variableCode(tsObj) {
            return tsObj?.variable?.variableCode?.[0]?.value;
          }
          function lastValue(tsObj) {
            const arr = tsObj?.values?.[0]?.value || [];
            for (let i = arr.length - 1; i >= 0; i--) {
              const v = arr[i]?.value;
              if (v !== undefined && v !== null && v !== "") return Number(v);
            }
            return null;
          }

          async function getState(st) {
            const url = `https://waterservices.usgs.gov/nwis/iv/?stateCd=${st}&${params}`;
            try {
              const res = await fetch(url, { headers: { "accept": "application/json" }});
              if (!res.ok) throw new Error(`HTTP ${res.status}`);
              const data = await res.json();
              const ts = data?.value?.timeSeries || [];
              for (const t of ts) {
                const code = variableCode(t);
                if (code !== "00010" && code !== "00095") continue;
                const site = siteCode(t);
                const state = stateOf(t) || st;
                if (!site) continue;

                const v = lastValue(t);
                let rec = bySite.get(site);
                if (!rec) { rec = { site, state, tempC: null, condu: null }; bySite.set(site, rec); }
                if (code === "00010") rec.tempC = v;
                if (code === "00095") rec.condu = v;
              }
            } catch (e) {
              console.warn("WARN AS:", e.message, "->", st);
            }
          }

          (async () => {
            // Pull gently to avoid throttling
            for (const st of states) { await getState(st); await sleep(800); }

            const itemsRaw = Array.from(bySite.values());

            // Clean/normalize readings
            const clean = itemsRaw.map(r => ({
              ...r,
              tempC: norm(r.tempC) === null ? null : +Number(r.tempC).toFixed(1),
              condu: norm(r.condu) === null ? null : Math.round(Number(r.condu)),
            }));

            // Group & medians
            const byState = new Map();
            for (const r of clean) {
              if (!r.state) continue;
              const key = r.state.toUpperCase();
              if (!byState.has(key)) byState.set(key, []);
              byState.get(key).push(r);
            }
            const median = (arr) => {
              const xs = arr.filter(v => v !== null);
              if (!xs.length) return null;
              xs.sort((a,b)=>a-b);
              const m = Math.floor(xs.length/2);
              const val = xs.length % 2 ? xs[m] : (xs[m-1] + xs[m]) / 2;
              return +Number(val).toFixed(1);
            };

            const stateSummary = [];
            for (const [st, rows] of [...byState.entries()].sort()) {
              const temps = rows.map(r=>r.tempC);
              const conds = rows.map(r=>r.condu);
              stateSummary.push({
                state: st,
                sites: rows.length,
                medianTempC: median(temps),
                medianCond_uScm: median(conds)
              });
            }

            // Write files
            const fs = require("fs");
            const stamp = new Date().toISOString();
            const out = { updatedAt: stamp, count: clean.length, items: clean };
            fs.writeFileSync("data/usgs-latest.json", JSON.stringify(out, null, 2));
            fs.writeFileSync("data/state-summary.json", JSON.stringify({ updatedAt: stamp, states: stateSummary }, null, 2));
            fs.writeFileSync("data/health.json", JSON.stringify({ updatedAt: stamp }, null, 2));
            console.log("Wrote", clean.length, "sites at", stamp);

            // Step summary (markdown)
            const fmt = (x)=> (x===null ? "—" : String(x));
            let md = `# USGS Cache Summary\n\nUpdated: ${stamp}\nTotal sites: ${clean.length}\n\n`;
            md += `| State | Sites | Median °C | Median µS/cm |\n|---:|---:|---:|---:|\n`;
            for (const s of stateSummary) {
              md += `| ${s.state} | ${s.sites} | ${fmt(s.medianTempC)} | ${fmt(s.medianCond_uScm)} |\n`;
            }
            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY || '/dev/null', md);
          })();
          NODE

      - name: Commit & push
        if: always()
        run: |
          git config user.name "admatera-bot"
          git config user.email "actions@users.noreply.github.com"
          git add data/usgs-latest.json data/state-summary.json data/health.json
          git commit -m "water cache $(date -u +'%F %T UTC')" || echo "no changes"
          git push
