name: USGS Water Cache (daily)

on:
  schedule:
    - cron: '15 12 * * *'   # 12:15 UTC daily
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: usgs-water-cache
  cancel-in-progress: true

jobs:
  cache-water:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch USGS temp (00010) + cond (00095) for all states & territories
        run: |
          mkdir -p data
          node -e '
          const sleep = ms => new Promise(r => setTimeout(r, ms));
          const states = [
            "al","ak","az","ar","ca","co","ct","de","fl","ga","hi","id","il","in","ia","ks","ky","la","me","md",
            "ma","mi","mn","ms","mo","mt","ne","nv","nh","nj","nm","ny","nc","nd","oh","ok","or","pa","ri","sc",
            "sd","tn","tx","ut","vt","va","wa","wv","wi","wy","dc","pr","as","gu","vi","mp"
          ];

          (async () => {
            const bySite = new Map();

            for (const st of states){
              const stCode = st.toUpperCase();
              const url = `https://waterservices.usgs.gov/nwis/iv/?format=json&parameterCd=00010,00095&siteType=ST&siteStatus=active&stateCd=${stCode}`;

              // fetch with 3 tries; if still bad, just skip this state
              let js = null;
              for (let attempt=1; attempt<=3; attempt++){
                try{
                  const res = await fetch(url, { headers: { "User-Agent":"admatera-water-cache" }});
                  if (res.ok){
                    js = await res.json();
                    break;
                  }
                }catch{}
                await sleep(400 * attempt);
              }
              if (!js){
                console.log("skip", stCode, "(no response)");
                await sleep(200);
                continue;
              }

              const ts = js?.value?.timeSeries || [];
              for (const t of ts){
                try{
                  const site = t?.sourceInfo?.siteCode?.[0]?.value;
                  const p    = t?.variable?.variableCode?.[0]?.value;  // 00010 or 00095
                  const arr  = t?.values?.[0]?.value || [];
                  if (!site || !p || arr.length === 0) continue;
                  const last = arr[arr.length - 1];
                  const dt   = last?.dateTime;
                  const num  = parseFloat(last?.value);
                  if (!Number.isFinite(num)) continue;
                  // ignore readings older than 48h
                  if (dt && (Date.now() - Date.parse(dt)) > 48*3600*1000) continue;

                  const rec = bySite.get(site) || { site, state: stCode.toLowerCase() };
                  if (p === "00010") rec.tempC = Math.round(num * 10) / 10;
                  else if (p === "00095") rec.condu = Math.round(num);
                  bySite.set(site, rec);
                } catch {}
              }

              await sleep(800); // be kind to API
            }

            const items = Array.from(bySite.values()).filter(r => ("tempC" in r) || ("condu" in r));
            const out = { updatedAt: new Date().toISOString(), count: items.length, items };
            const fs = require("fs");
            fs.writeFileSync("data/usgs-latest.json", JSON.stringify(out, null, 2));
            fs.writeFileSync("data/health.json", JSON.stringify({ updatedAt: out.updatedAt }, null, 2));
            console.log("Wrote", items.length, "sites");
          })().catch(e => { console.error(e); process.exit(1); });
          '

      - name: Commit & push
        run: |
          git config user.name  "admatera-bot"
          git config user.email "actions@users.noreply.github.com"
          git add data/usgs-latest.json data/health.json
          git commit -m "water cache $(date -u +'%F %T UTC')" || echo "no changes"
          git push
