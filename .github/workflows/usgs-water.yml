name: USGS Water Cache (daily)

on:
  schedule:
    - cron: '10 03 * * *'   # 03:10 UTC daily (adjust later)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cache-water:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Write fetcher script
        run: |
          mkdir -p data
          cat > fetch-usgs.mjs <<'JS'
          import fs from 'node:fs/promises';

          // Lowercase USPS codes for 50 states + DC
          const STATES = ['al','ak','az','ar','ca','co','ct','de','fl','ga','hi','id','il','in','ia','ks','ky','la','me','md','ma','mi','mn','ms','mo','mt','ne','nv','nh','nj','nm','ny','nc','nd','oh','ok','or','pa','ri','sc','sd','tn','tx','ut','vt','va','wa','wv','wi','wy','dc'];

          const BASE = 'https://waterservices.usgs.gov/nwis/iv/';
          const PARAMS = 'parameterCd=00010,00095&siteType=ST&siteStatus=active&format=json';
          const sleep = ms => new Promise(r => setTimeout(r, ms));

          async function fetchState(sc) {
            const url = `${BASE}?${PARAMS}&stateCd=${sc}`;
            const maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
              const res = await fetch(url);
              if (res.ok) return res.json();
              await sleep(500 * (i + 1));
            }
            throw new Error(`USGS fetch failed for ${sc}`);
          }

          function parseSeries(series) {
            const getParam = s => s.variable?.variableCode?.[0]?.value;
            const getSite  = s => s.sourceInfo?.siteCode?.[0]?.value;
            const getVal   = s => s.values?.[0]?.value?.[0]?.value;
            const out = {};
            for (const s of series) {
              const param = getParam(s);
              const site  = getSite(s);
              const val   = getVal(s);
              if (!param || !site || val == null) continue;
              const rec = out[site] ?? { site };
              if (param === '00010') rec.tempC = Number(val);
              if (param === '00095') rec.condu = Number(val);
              out[site] = rec;
            }
            return out;
          }

          const bySite = new Map();
          for (const sc of STATES) {
            const j = await fetchState(sc);
            const series = j.value?.timeSeries ?? [];
            const parsed = parseSeries(series);
            for (const rec of Object.values(parsed)) {
              const prev = bySite.get(rec.site) || {};
              bySite.set(rec.site, { ...prev, ...rec, state: sc });
            }
            await sleep(750); // be kind to USGS
          }

          const items = Array.from(bySite.values());
          const stamp = new Date().toISOString();
          const out = { updatedAt: stamp, count: items.length, items };

          await fs.writeFile('data/usgs-latest.json', JSON.stringify(out, null, 2));
          await fs.writeFile('data/health.json', JSON.stringify({ updatedAt: stamp }, null, 2));
          JS

      - name: Fetch & write JSON
        run: node fetch-usgs.mjs

      - name: Commit & push
        run: |
          git config user.name  "admatera-bot"
          git config user.email "actions@users.noreply.github.com"
          git add data/usgs-latest.json data/health.json
          git commit -m "water cache $(date -u +'%F %T UTC')" || echo "no changes"
          git push
