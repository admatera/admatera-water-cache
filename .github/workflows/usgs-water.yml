name: USGS Water Cache (daily)

on:
  schedule:
    - cron: '17 11 * * *'   # daily 11:17 UTC (change later if you want)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cache-water:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch USGS temp (00010) + cond (00095) for all states & territories
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data

          node --input-type=module <<'NODE'
          // Resilient union (temp OR cond) + per-request retries + keep-going on state errors.
          const sleep = (ms) => new Promise(r => setTimeout(r, ms));

          // 50 states + DC + territories (USGS uses two-letter lowercases)
          const STATES = [
            'al','ak','az','ar','ca','co','ct','de','fl','ga','hi','id','il','in','ia','ks','ky','la','me','md','ma','mi','mn','ms','mo','mt',
            'ne','nv','nh','nj','nm','ny','nc','nd','oh','ok','or','pa','ri','sc','sd','tn','tx','ut','vt','va','wa','wv','wi','wy',
            'dc','pr','vi','gu','as','mp'
          ];

          const base = 'https://waterservices.usgs.gov/nwis/iv/';
          const makeURL = (state, param) =>
            `${base}?format=json&stateCd=${state}&siteType=ST&siteStatus=active&parameterCd=${param}`;

          async function getJson(url, tries = 4) {
            for (let a = 1; a <= tries; a++) {
              try {
                const res = await fetch(url, { headers: { 'accept': 'application/json' }});
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return await res.json();
              } catch (e) {
                if (a === tries) throw e;
                await sleep(400 * a);
              }
            }
          }

          const sites = new Map(); // site -> { site, state, tempC?, condu? }

          async function fetchState(state) {
            const urls = [makeURL(state, '00010'), makeURL(state, '00095')]; // temp, conductance
            for (const url of urls) {
              try {
                const j = await getJson(url);
                const ts = j?.value?.timeSeries || [];
                for (const series of ts) {
                  const site = series?.sourceInfo?.siteCode?.[0]?.value;
                  const vcode = series?.variable?.variableCode?.[0]?.value;
                  const last = series?.values?.[0]?.value?.at(-1)?.value;
                  if (!site || last == null) continue;
                  const rec = sites.get(site) ?? { site, state };
                  if (vcode === '00010') rec.tempC = Number(last);
                  if (vcode === '00095') rec.condu = Number(last);
                  sites.set(site, rec);
                }
                await sleep(250); // gentle between param calls
              } catch (e) {
                console.log(`WARN ${state}: ${e.message}`);
              }
            }
            await sleep(300); // gentle between states
          }

          (async () => {
            for (const st of STATES) await fetchState(st);
            const items = Array.from(sites.values());
            const stamp = new Date().toISOString();
            const fs = await import('node:fs');
            fs.writeFileSync('data/usgs-latest.json', JSON.stringify({ updatedAt: stamp, count: items.length, items }, null, 2));
            fs.writeFileSync('data/health.json', JSON.stringify({ updatedAt: stamp }, null, 2));
            console.log(`Wrote ${items.length} sites at ${stamp}`);
          })().catch(e => { console.error(e); process.exit(1); });
          NODE

      - name: Show summary
        run: |
          echo "Health:" && cat data/health.json || true
          echo "Count:" && (jq -r '.count' data/usgs-latest.json || true)

      - name: Commit & push
        run: |
          git config user.name  "admatera-bot"
          git config user.email "actions@users.noreply.github.com"
          git add data/usgs-latest.json data/health.json
          git commit -m "water cache $(date -u +'%F %T UTC')" || echo "no changes"
          git push
